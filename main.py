import streamlit as st
import torch
from diffusers import StableDiffusionPipeline


# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤ —Ç.—á. –ø–æ–ª–Ω–æ–æ–∫–æ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
st.set_page_config(layout="wide",
                   page_title="make_pic",
                   page_icon="üè†")


model_id = "runwayml/stable-diffusion-v1-5"
# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏. –ï—Å–ª–∏ cuda –¥–æ—Å—Ç—É–ø–Ω–∞, –≥—Ä—É–∑–∏–º –ø–æ–¥ –Ω–µ—ë
# –ï—Å–ª–∏ –Ω–µ—Ç, –≥—Ä—É–∑–∏–º –ø–æ–¥ cpu
if torch.cuda.is_available():
    st.write("on CUDA")
    pipe = StableDiffusionPipeline.from_pretrained(model_id,
                                                   torch_dtype=torch.float16)
    pipe = pipe.to("cuda")

else:
    st.write("on CPU")
    pipe = StableDiffusionPipeline.from_pretrained(model_id)
    pipe = pipe.to("cpu")


def image_gen(prompt):
    '''
    –Ω–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—ë–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
    –Ω–∞ –≤—ã—Ö–æ–¥–µ –ø–æ–ª—É—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    '''
    return pipe(prompt).images[0]


# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.write("# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é")

# –°—Ç—Ä–æ–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
prompt = st.text_area("–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏",
                      value="A reindeer next to the chum",
                      help="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏")

# –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–æ–¥–µ–ª–∏
btn = st.button("–°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É",
                help="–ñ–º–∞–∫–∞–π –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏")

# –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –∂–º–∞–∫–Ω—É—Ç–∞, –∑–∞–ø—É—Å–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏
if btn:
    image = image_gen(prompt)
    # –í—ã–≤–æ–¥–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω
    st.image(image,
             caption="–í–æ—Ç —Ç–∞–∫–∞—è –≤–æ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∞")
